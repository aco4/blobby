<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial; padding: 20px; }
        .description { text-align: center; }
        .buttons { display: flex; justify-content: center; gap: 2px; }
        .counter { text-align: center; font-size: 2em; font-weight: bold; margin: 20px auto; }
        .board { display: grid; grid-template-columns: repeat(var(--columns), 30px); width: fit-content; margin: 20px auto; grid-auto-rows: 30px; }
        .cell { width: 30px; height: 30px; border: 1px solid #bbb; cursor: pointer; }
        .selected-button { background-color: #007BFF; color: white; font-weight: bold; }

        .c0  { background: #FFFFFF; } /* white */
        .c1  { background: #E53E3E; } /* red */
        .c2  { background: #3182CE; } /* blue */
        .c3  { background: #38A169; } /* green */
        .c4  { background: #D69E2E; } /* yellow/gold */
        .c5  { background: #805AD5; } /* purple */
        .c6  { background: #DD6B20; } /* orange */
        .c7  { background: #319795; } /* teal */
        .c8  { background: #7F1D1D; } /* dark red goal */
        .c9  { background: #1E3A8A; } /* dark blue goal */
        .c10 { background: #14532D; } /* dark green goal */
        .c11 { background: #713F12; } /* dark gold goal */
        .c12 { background: #4C1D95; } /* dark purple goal */
        .c13 { background: #7C2D12; } /* dark orange goal */
        .c14 { background: #134E4A; } /* dark teal goal */
        .c15 { background: #000000; } /* black */
    </style>
</head>
<body>
    <div class="buttons" id="buttons"></div>
    <div class="counter" id="counter">20</div>
    <div class="board" id="board"></div>
    <p class="description" id="description">Left Click</p>

    <script type="text/javascript">
        const levels = [
            {
                "clicks": 20,
                "enableGrow": true,
                "enableShrink": false,
                "grid": [
                    [00,00,00,00,00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00,00,00,00,00],
                    [08,01,00,00,00,00,00,00,00,00,00,00,00,00,08],
                    [00,00,00,00,00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,02,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00,00,00,00,00],
                ]
            },
            {
                "clicks": 10,
                "enableGrow": true,
                "enableShrink": false,
                "grid": [
                    [00,00,00,00,00,00,08,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,01,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,08,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00,00,00],
                    [11,00,04,00,11,00,00,00,09,00,02,00,09],
                    [00,00,00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,10,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,03,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,10,00,00,00,00,00,00],
                ]
            },
            {
                "clicks": 20,
                "enableGrow": true,
                "enableShrink": false,
                "grid": [
                    [00,00,00,00,00],
                    [00,08,00,09,00],
                    [00,00,00,00,00],
                    [00,00,00,00,00],
                    [00,00,00,00,00],
                    [00,00,00,00,00],
                    [00,00,00,00,00],
                    [00,00,00,00,00],
                    [00,00,00,00,00],
                    [00,00,00,00,00],
                    [00,01,00,02,00],
                    [00,08,00,09,00],
                    [00,00,00,00,00],
                ]
            },
            {
                "clicks": 10,
                "enableGrow": true,
                "enableShrink": false,
                "grid": [
                    [0,0,9,0,0,0,9],
                    [0,0,0,0,0,0,0],
                    [0,0,1,0,2,0,0],
                    [0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0],
                    [8,0,0,0,0,0,8],
                ]
            },
            {
                "clicks": 20,
                "enableGrow": true,
                "enableShrink": false,
                "grid": [
                    [0,0,1,1,1,0,0,0,8],
                    [0,1,1,0,9,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,2,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,10,0,0,0,0],
                    [0,0,0,0,0,0,0,3,3],
                    [0,0,0,0,0,0,0,0,0],
                    [0,0,0,8,0,9,0,0,10],
                ]
            },
            {
                "clicks": 35,
                "enableGrow": true,
                "enableShrink": true,
                "grid": [
                    [00,00,00,08,00,00,00,00,00,08],
                    [00,00,00,01,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00],
                    [09,00,00,00,00,02,09,00,00,00],
                ]
            },
            {
                "clicks": 20,
                "enableGrow": true,
                "enableShrink": true,
                "grid": [
                    [00,00,00,00,00,00,00],
                    [00,09,00,00,00,00,00],
                    [00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00],
                    [00,00,00,00,00,01,08],
                    [00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00],
                    [00,02,00,00,00,00,00],
                    [00,09,00,00,00,00,00],
                    [00,00,00,00,00,00,00],
                    [00,00,00,00,03,03,00],
                    [00,00,00,00,00,00,08],
                ]
            },
            {
                "clicks": 50,
                "enableGrow": true,
                "enableShrink": true,
                "grid": [
                    [00,00,00,00,00,00,00,00,08,00,00,00],
                    [00,00,00,00,00,03,03,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,15,00,00,00,00,00,00,00,00,00],
                    [00,00,15,00,00,00,00,00,00,00,00,00],
                    [00,00,15,09,02,00,00,00,00,00,00,09],
                    [00,00,15,00,00,00,00,00,00,00,00,00],
                    [00,00,15,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,03,03,00,01,00,00,00],
                    [00,00,00,00,00,00,00,00,08,00,00,00],
                ]
            },
            {
                "clicks": 50,
                "enableGrow": true,
                "enableShrink": true,
                "grid": [
                    [00,00,00,00,00,00,00,00,15,00,00,00,09],
                    [00,00,00,00,00,00,00,00,15,00,00,03,00],
                    [00,00,00,00,00,00,00,00,15,00,00,00,00],
                    [00,00,00,00,00,00,00,00,15,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00,00,00],
                    [00,01,01,00,00,02,00,00,15,00,00,00,00],
                    [08,01,01,00,09,02,00,00,15,00,00,00,00],
                    [00,01,01,00,00,02,00,00,15,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,15,00,00,00,00],
                    [00,00,00,00,00,00,00,00,15,00,00,00,00],
                    [00,00,00,00,00,00,00,00,15,00,00,04,00],
                    [00,00,00,00,00,00,00,00,15,00,00,00,08],
                ]
            },
            {
                "clicks": 70,
                "enableGrow": true,
                "enableShrink": true,
                "grid": [
                    [00,00,00,00,00,00,00,00,00,00,00],
                    [00,08,00,00,00,03,00,00,00,08,00],
                    [00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00],
                    [00,09,02,00,00,00,00,00,00,09,00],
                    [00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00],
                    [00,00,00,00,00,00,00,00,00,00,00],
                    [00,10,00,00,00,01,00,00,00,10,00],
                    [00,00,00,00,00,00,00,00,00,00,00],
                ]
            }
        ];

        let grid, clicks, selectedLevel, isGameOver;

        function gridWidth() {
            return grid?.[0]?.length;
        }

        function gridLength() {
            return grid?.length;
        }

        function outOfBounds(x, y) {
            return x < 0 || x >= gridWidth() || y < 0 || y >= gridLength();
        }

        // Returns true if the cell is next to an empty cell
        function onEdge(x, y) {
            if (outOfBounds(x, y)) return false;
            return grid?.[y+1]?.[x] === 0 ||
                   grid?.[y-1]?.[x] === 0 ||
                   grid?.[y]?.[x+1] === 0 ||
                   grid?.[y]?.[x-1] === 0;
        }

        function isEmpty(x, y) {
            return grid[y][x] == 0;
        }

        function isBlob(x, y) {
            return grid[y][x] >= 1 && grid[y][x] <= 7;
        }

        function isWall(x, y) {
            return grid[y][x] == 15;
        }

        function isGoal(x, y) {
            return grid[y][x] >= 8 && grid[y][x] <= 14;
        }

        function canGrow() {
            return levels[selectedLevel].enableGrow;
        }

        function canShrink() {
            return levels[selectedLevel].enableShrink;
        }

        // Render once on start
        function renderButtons() {
            const container = document.getElementById("buttons");
            container.innerHTML = ""; // clear old buttons before re-rendering

            for (let i = 0; i < levels.length; i++) {
                const button = document.createElement("button");
                button.textContent = `Level ${i + 1}`;
                if (i == selectedLevel) button.classList.add("selected-button");
                button.onclick = () => reset(i);
                container.appendChild(button);
            }
        }

        function render() {
            // Render action text
            document.getElementById('description').textContent = `Left${canShrink() ? "/right" : ""} click`;

            // Render click counter
            document.getElementById('counter').textContent = clicks;

            // Render grid
            const board = document.getElementById('board');
            board.style.setProperty('--columns', gridWidth());
            board.innerHTML = '';
            for (let y = 0; y < gridLength(); y++) {
                for (let x = 0; x < gridWidth(); x++) {
                    const cell = document.createElement('div');
                    cell.className = `cell c${grid[y][x]}`;
                    cell.onclick = () => click(x, y, "LEFT");
                    cell.oncontextmenu = (e) => { e.preventDefault(); click(x, y, "RIGHT"); };
                    board.appendChild(cell);
                }
            }
        }

        // Returns an array of [x, y]
        // onVisit - a function that is called whenever a cell is visited
        // canContinue - a function that returns true if the flood fill can continue to x, y
        function floodFill(startX, startY, onVisit, canContinue) {
            const color = grid[startY][startX];
            const blob = [];
            const visited = new Set();
            const queue = [[startX, startY]];

            while (queue.length > 0) {
                const [x, y] = queue.shift();
                const key = `${x},${y}`;
                if (visited.has(key)) continue;
                if (outOfBounds(x, y)) continue;
                onVisit(x, y);
                if (canContinue ? !canContinue(x, y) : grid[y][x] !== color) continue;

                visited.add(key);
                blob.push([x, y]);

                queue.push([x+1, y], [x-1, y], [x, y+1], [x, y-1]);
            }
            return blob;
        }

        function click(x, y, action) {
            if (isGameOver) return;
            if (clicks == 0) {
                alert("Game over");
                isGameOver = true;
                return;
            }
            if (action == "LEFT" && canGrow()) {
                grow(x, y);
            } else if (action == "RIGHT" && canShrink()) {
                shrink(x, y);
            }
            checkWin();
        }

        function checkWin() {
            const goalToBlob = { 8: 1, 9: 2, 10: 3, 11: 4, 12: 5, 13: 6, 14: 7 };

            for (let goalColor = 8; goalColor <= 14; goalColor++) {
                const requiredBlob = goalToBlob[goalColor];

                // Collect all positions of this goal
                const goals = [];
                for (let y = 0; y < gridLength(); y++) {
                    for (let x = 0; x < gridWidth(); x++) {
                        if (grid[y][x] === goalColor) {
                            goals.push([x, y]);
                        }
                    }
                }

                if (goals.length === 0) continue; // no goals of this type on board

                // Start flood fill from the first goal
                const visitedGoals = new Set();
                floodFill(
                    goals[0][0],
                    goals[0][1],
                    (x, y) => {
                        if (grid[y][x] === goalColor) {
                            visitedGoals.add(`${x},${y}`);
                        }
                    },
                    (x, y) => {
                        return grid[y][x] === goalColor || grid[y][x] === requiredBlob;
                    }
                );

                // Check that all goals of this type were reached
                for (const [gx, gy] of goals) {
                    if (!visitedGoals.has(`${gx},${gy}`)) {
                        return false; // this group of goals not connected
                    }
                }
            }

            // If we made it here, all goals are satisfied
            setTimeout(() => alert("You win!"), 10);

            isGameOver = true;
            return true;
        }

        function grow(x, y) {
            if (!isBlob(x, y)) return;
            const color = grid[y][x];

            const pending = new Set();
            const blob = floodFill(x, y,
                (x, y) => {
                    if (grid[y][x] == 0) pending.add([x, y]);
                }
            );
            if (pending.size == 0) return;
            for (const [ex, ey] of pending) {
                grid[ey][ex] = color;
            }

            clicks--;
            render();
        }

        function shrink(x, y) {
            if (!isBlob(x, y)) return;
            const color = grid[y][x];

            const pending = new Set();
            const blob = floodFill(x, y,
                (x, y) => {
                    if (grid[y][x] == color && onEdge(x, y)) pending.add([x, y]);
                }
            );
            if (pending.size == 0) return;
            for (const [ex, ey] of pending) {
                grid[ey][ex] = 0;
            }

            clicks--;
            render();
        }

        function reset(level) {
            selectedLevel = level;
            isGameOver = false;
            grid = structuredClone(levels[level].grid);
            clicks = levels[level].clicks;
            renderButtons();
            render();
        }

        reset(0);
        render();
    </script>
</body>
</html>
